import * as esb from 'esbuild';
import { GasPlugin } from 'esbuild-gas-plugin';


import * as threads from 'threads/worker';



interface EsbConfig {
	files: {
		tsconfig: object,
		entries: string[],
	}
	type: 'bundle-debug' | 'development' | 'local' | 'ci'
}


export const esbInterface = {
	/**
	 * An extremely opinionated ESBuild interface for compiling TypeScript into Google Apps Script
	 */
	build(config: EsbConfig) {
		let logLevel = '';
		switch (config.type) {
			case 'bundle-debug':
				logLevel = 'debug';
				break;
			case 'development':
				logLevel = 'info';
				break;
			case 'local':
				logLevel = 'info';
				break;
			case 'ci':
				logLevel = 'info';
				break;
			default:
				logLevel = 'info';
				break;
		}
		return esb.build({
			write: false,
			entryPoints: config.files.entries,
			bundle: true,
			tsconfigRaw: config.files.tsconfig,
			plugins: [
				GasPlugin,
			],
			footer: {
				js: `/*
	This file was generated by the Artsy Build System!
	Built on ${new Date().toLocaleTimeString()}.
	Don't even think about editing this file.
	To modify the code, build Articleman again yourself,
	from github.com/bluelinden/articleman. This file is not
	meant to be readable or editable.
*/`,},
			color: true,



		})
	}
}

threads.expose(esbInterface);
